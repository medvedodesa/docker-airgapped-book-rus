# /etc/sysctl.d/99-docker-hardening.conf
# Kernel hardening for Docker hosts in air-gapped environments
#
# Apply with: sysctl -p /etc/sysctl.d/99-docker-hardening.conf
# Or reload all: sysctl --system

# ============================================
# NETWORK SECURITY
# ============================================

# IP Forwarding (REQUIRED for Docker)
# Docker needs this for container networking
net.ipv4.ip_forward = 1

# Reverse Path Filtering (anti-spoofing)
# Verify source address is reachable via incoming interface
net.ipv4.conf.all.rp_filter = 1
net.ipv4.conf.default.rp_filter = 1

# ICMP Redirect Protection
# Prevents MITM attacks via malicious ICMP redirects
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.conf.all.secure_redirects = 0
net.ipv4.conf.default.secure_redirects = 0
net.ipv6.conf.all.accept_redirects = 0
net.ipv6.conf.default.accept_redirects = 0

# Don't send ICMP redirects
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0

# Source Route Protection
# Prevent source routing (attackers defining packet path)
net.ipv4.conf.all.accept_source_route = 0
net.ipv4.conf.default.accept_source_route = 0
net.ipv6.conf.all.accept_source_route = 0
net.ipv6.conf.default.accept_source_route = 0

# ICMP Settings
# Ignore broadcast pings (prevents smurf attacks)
net.ipv4.icmp_echo_ignore_broadcasts = 1

# Ignore bogus ICMP error responses
net.ipv4.icmp_ignore_bogus_error_responses = 1

# TCP SYN Cookies (SYN flood protection)
# Enables SYN cookies to handle SYN flood attacks
net.ipv4.tcp_syncookies = 1

# TCP Settings for Security
# Disable TCP timestamps (prevents uptime discovery)
net.ipv4.tcp_timestamps = 0

# Log Suspicious Packets
# Log martian packets (impossible source addresses)
net.ipv4.conf.all.log_martians = 1
net.ipv4.conf.default.log_martians = 1

# IPv6 Configuration
# Disable IPv6 if not used in air-gapped environment
# Comment out if IPv6 is required
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1

# IPv6 Router Advertisements (if IPv6 enabled)
# net.ipv6.conf.all.accept_ra = 0
# net.ipv6.conf.default.accept_ra = 0

# ============================================
# KERNEL SECURITY
# ============================================

# Kernel Pointer Restriction
# Hide kernel addresses from /proc and other interfaces
# 0 = no restrictions
# 1 = restricted (prevent leaking addresses)
# 2 = hide from everyone except root
kernel.kptr_restrict = 2

# Restrict dmesg
# Prevent unprivileged users from viewing kernel logs
kernel.dmesg_restrict = 1

# Address Space Layout Randomization (ASLR)
# Randomize memory addresses to prevent exploitation
# 0 = disabled
# 1 = randomize stack, VDSO, shared memory
# 2 = full randomization (recommended)
kernel.randomize_va_space = 2

# Ptrace Scope
# Restrict process debugging/tracing
# 0 = classic ptrace permissions (any process can trace any other)
# 1 = restricted (only parent processes or CAP_SYS_PTRACE)
# 2 = admin-only (only CAP_SYS_PTRACE)
# 3 = no ptrace (completely disabled)
kernel.yama.ptrace_scope = 1

# Core Dumps
# Disable SUID core dumps (may contain sensitive data)
fs.suid_dumpable = 0

# Core dump naming
kernel.core_uses_pid = 1

# Restrict kernel logs
kernel.printk = 3 3 3 3

# ============================================
# FILESYSTEM SECURITY
# ============================================

# Protect hardlinks and symlinks
# Prevents hardlink/symlink attacks in world-writable directories
fs.protected_hardlinks = 1
fs.protected_symlinks = 1

# ============================================
# PROCESS LIMITS
# ============================================

# Maximum PID value
# Default is usually 32768, increase for high-density containers
kernel.pid_max = 65536

# ============================================
# VIRTUAL MEMORY
# ============================================

# VM overcommit behavior
# 0 = heuristic overcommit (default)
# 1 = always overcommit (dangerous)
# 2 = don't overcommit (strict accounting)
vm.overcommit_memory = 0

# Percentage of RAM for overcommit
vm.overcommit_ratio = 50

# Swappiness (how aggressively kernel swaps)
# 0-100, lower = less swapping
# 10 is good for servers to keep apps in memory
vm.swappiness = 10

# ============================================
# NETWORK PERFORMANCE (OPTIONAL)
# ============================================

# TCP Buffer Sizes
# Increase for high-bandwidth Docker networking
# net.core.rmem_max = 134217728
# net.core.wmem_max = 134217728
# net.ipv4.tcp_rmem = 4096 87380 67108864
# net.ipv4.tcp_wmem = 4096 65536 67108864

# Connection Tracking
# Increase if running many containers
# net.netfilter.nf_conntrack_max = 262144

# ============================================
# DOCKER-SPECIFIC SETTINGS
# ============================================

# Bridge netfilter
# Required for Docker networking
net.bridge.bridge-nf-call-iptables = 1
net.bridge.bridge-nf-call-ip6tables = 1

# ============================================
# USER NAMESPACES
# ============================================

# Maximum user namespaces
# Set to 0 to disable unprivileged namespace creation
# Docker user namespace remapping requires > 0
# user.max_user_namespaces = 15000

# Note: If using Docker userns-remap, keep enabled
# If not using, can set to 0 for additional security

# ============================================
# NOTES
# ============================================

# 1. IP Forwarding:
#    - Required for Docker container networking
#    - Cannot be disabled if running Docker
#    - Secure with iptables rules instead

# 2. User Namespaces:
#    - If using Docker userns-remap, keep max_user_namespaces > 0
#    - If not using, set to 0 for security

# 3. IPv6:
#    - Disabled by default for air-gapped environments
#    - Enable if needed for your infrastructure

# 4. Apply Settings:
#    sysctl -p /etc/sysctl.d/99-docker-hardening.conf

# 5. Verify Settings:
#    sysctl -a | grep -E "ipv4|kernel|vm"

# 6. Persistent:
#    Settings in /etc/sysctl.d/ are loaded at boot

# ============================================
# VALIDATION
# ============================================

# After applying, verify critical settings:
# sysctl net.ipv4.ip_forward              # Should be 1
# sysctl net.ipv4.conf.all.rp_filter      # Should be 1
# sysctl kernel.randomize_va_space         # Should be 2
# sysctl kernel.kptr_restrict              # Should be 2
# sysctl net.ipv4.tcp_syncookies          # Should be 1

# ============================================
# REBOOT RECOMMENDATION
# ============================================

# Some settings may require a reboot to fully take effect
# Particularly kernel.modules_disabled if used
